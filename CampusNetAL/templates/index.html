<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园网自动登录</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>校园网自动登录系统</h1>
            <div id="status-indicator" class="status">
                <span>状态: 加载中...</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">仪表盘</button>
            <button class="tab-btn" data-tab="config">配置管理</button>
            <button class="tab-btn" data-tab="logs">日志查看</button>
        </div>

        <div class="tab-content" id="dashboard">
            <div class="card">
                <h2>系统信息</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">当前账号:</span>
                        <span id="current-username">加载中...</span>
                    </div>
                    <div class="info-item">
                        <span class="label">检测间隔:</span>
                        <span id="check-interval">加载中...</span>
                    </div>
                    <div class="info-item">
                        <span class="label">登录状态:</span>
                        <span id="login-status">加载中...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content hidden" id="config">
            <div class="card">
                <h2>配置设置</h2>
                <form id="config-form">
                    <div class="form-group">
                        <label for="username">账号</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">密码</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="check_interval">检测间隔(秒)</label>
                        <input type="number" id="check_interval" name="check_interval" min="5" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="detect_url">检测URL</label>
                        <input type="url" id="detect_url" name="detect_url" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login_base_url">登录基础URL</label>
                        <input type="url" id="login_base_url" name="login_base_url" required>
                    </div>
                    
                    <h3>检测标志配置</h3>
                    
                    <div class="form-group">
                        <label for="not_logged_flag">未登录标志</label>
                        <input type="text" id="not_logged_flag" name="not_logged_flag" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="logged_success_flag">已登录标志</label>
                        <input type="text" id="logged_success_flag" name="logged_success_flag" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login_success_flag">登录成功标志</label>
                        <input type="text" id="login_success_flag" name="login_success_flag" required>
                    </div>
                    
                    <button type="submit" class="btn save-btn">保存配置</button>
                </form>
                <div id="save-message" class="message"></div>
            </div>
        </div>

        <div class="tab-content hidden" id="logs">
            <div class="card">
                <h2>系统日志</h2>
                <div class="log-container">
                    <pre id="log-content"></pre>
                </div>
                <button id="clear-logs" class="btn">清空日志</button>
            </div>
        </div>
    </div>

    <script>
        // 切换标签页
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // 移除所有活动状态
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                
                // 设置当前活动状态
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');
                
                // 如果切换到日志标签，刷新日志
                if (tabId === 'logs') {
                    fetchLogs();
                }
            });
        });

        // 获取并显示配置
        function fetchConfig() {
            fetch('/get_config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('username').value = data.username;
                    document.getElementById('password').value = data.password;
                    document.getElementById('check_interval').value = data.check_interval;
                    document.getElementById('detect_url').value = data.detect_url;
                    document.getElementById('login_base_url').value = data.login_base_url;
                    document.getElementById('not_logged_flag').value = data.not_logged_flag;
                    document.getElementById('logged_success_flag').value = data.logged_success_flag;
                    document.getElementById('login_success_flag').value = data.login_success_flag;
                })
                .catch(error => console.error('获取配置失败:', error));
        }

        // 保存配置
        document.getElementById('config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const configData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                check_interval: document.getElementById('check_interval').value,
                detect_url: document.getElementById('detect_url').value,
                login_base_url: document.getElementById('login_base_url').value,
                not_logged_flag: document.getElementById('not_logged_flag').value,
                logged_success_flag: document.getElementById('logged_success_flag').value,
                login_success_flag: document.getElementById('login_success_flag').value
            };
            
            fetch('/save_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('save-message');
                messageEl.textContent = data.message;
                messageEl.className = 'message ' + (data.status === 'success' ? 'success' : 'error');
                
                // 3秒后清除消息
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }, 3000);
                
                // 刷新状态信息
                fetchStatus();
            })
            .catch(error => console.error('保存配置失败:', error));
        });

        // 获取并显示日志
        function fetchLogs() {
            fetch('/get_logs')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('log-content').textContent = data.logs;
                    // 滚动到日志底部
                    const logContainer = document.querySelector('.log-container');
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => console.error('获取日志失败:', error));
        }

        // 清空日志
        document.getElementById('clear-logs').addEventListener('click', function() {
            if (confirm('确定要清空日志吗？')) {
                fetch('/clear_logs')
                    .then(response => response.json())
                    .then(data => {
                        fetchLogs();
                    })
                    .catch(error => console.error('清空日志失败:', error));
            }
        });

        // 获取并显示状态
        function fetchStatus() {
            fetch('/get_status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-username').textContent = data.username;
                    document.getElementById('check-interval').textContent = data.check_interval + '秒';
                    
                    const loginStatusEl = document.getElementById('login-status');
                    const statusIndicator = document.getElementById('status-indicator').querySelector('span');
                    
                    if (data.login_status) {
                        loginStatusEl.textContent = '已登录';
                        loginStatusEl.className = 'status-online';
                        statusIndicator.textContent = '状态: 正常运行 (已登录)';
                    } else {
                        loginStatusEl.textContent = '未登录';
                        loginStatusEl.className = 'status-offline';
                        statusIndicator.textContent = '状态: 正常运行 (未登录)';
                    }
                })
                .catch(error => console.error('获取状态失败:', error));
        }

        // 初始化页面
        window.onload = function() {
            fetchConfig();
            fetchStatus();
            fetchLogs();
            
            // 定时刷新状态和日志
            setInterval(fetchStatus, 10000);  // 10秒刷新一次状态
            setInterval(() => {
                if (!document.getElementById('logs').classList.contains('hidden')) {
                    fetchLogs();
                }
            }, 5000);  // 5秒刷新一次日志（仅在日志页）
        };
    </script>
</body>
</html>